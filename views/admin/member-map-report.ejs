<% title = 'Member Location Map' %>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""/>

<div class="px-4 sm:px-0">
  <div class="mb-6">
    <a href="/admin/reports" class="text-sm font-semibold text-indigo-600 hover:text-indigo-500">
      <svg class="inline-block h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Back to Reports
    </a>
  </div>

  <div class="mb-6">
    <h1 class="text-3xl font-bold tracking-tight text-gray-900">Member Location Map</h1>
    <p class="mt-2 text-sm text-gray-600">Interactive map showing locations of <%= members.length %> active members</p>
  </div>

  <!-- Map Container -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-6">
    <div id="map" style="height: 600px;"></div>
  </div>

  <!-- Member List -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Active Members (<%= members.length %>)</h2>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Member</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Callsign</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">County</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% members.forEach(member => { %>
            <tr class="hover:bg-gray-50 cursor-pointer member-row" data-member-id="<%= member.id %>">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900"><%= member.first_name %> <%= member.last_name %></div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900"><%= member.callsign %></div>
              </td>
              <td class="px-6 py-4">
                <div class="text-sm text-gray-900"><%= member.address %></div>
                <div class="text-sm text-gray-500"><%= member.city %>, <%= member.state %> <%= member.zip %></div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900"><%= member.county %></div>
              </td>
              <td class="px-6 py-4">
                <div class="text-sm text-gray-900"><%= member.phone %></div>
                <div class="text-sm text-gray-500"><%= member.email %></div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>

<script>
// Initialize the map
const map = L.map('map').setView([39.8283, -98.5795], 4); // Centered on USA

// Add OpenStreetMap tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  maxZoom: 19
}).addTo(map);

// Member data
const members = <%- JSON.stringify(members) %>;

// Store markers for interaction
const markers = {};

// Custom icon
const memberIcon = L.divIcon({
  className: 'custom-div-icon',
  html: `<div style="background-color: #4F46E5; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
  iconSize: [24, 24],
  iconAnchor: [12, 12]
});

// Helper function to delay between requests
const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

// Geocode addresses with rate limiting (1 request per second to respect Nominatim usage policy)
async function geocodeMembers() {
  const results = [];
  
  for (let i = 0; i < members.length; i++) {
    const member = members[i];
    const address = `${member.address}, ${member.city}, ${member.state} ${member.zip}`;
    
    try {
      // Add User-Agent header requirement for Nominatim
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`, {
        headers: {
          'User-Agent': 'ARES-Depot-Member-Map'
        }
      });
      
      if (!response.ok) {
        console.warn(`Failed to geocode ${member.callsign}: HTTP ${response.status}`);
        results.push(null);
        continue;
      }
      
      const data = await response.json();
      
      if (data && data.length > 0) {
        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);
        
        const popupContent = `
          <div style="min-width: 200px;">
            <h3 style="font-weight: bold; margin-bottom: 8px; font-size: 14px;">${member.first_name} ${member.last_name}</h3>
            <p style="margin: 4px 0; font-size: 13px;"><strong>Callsign:</strong> ${member.callsign}</p>
            <p style="margin: 4px 0; font-size: 12px; color: #666;">${member.address}<br>${member.city}, ${member.state} ${member.zip}</p>
            <p style="margin: 4px 0; font-size: 12px;"><strong>County:</strong> ${member.county}</p>
            <p style="margin: 4px 0; font-size: 12px;">${member.phone}</p>
            <p style="margin: 4px 0; font-size: 12px; color: #666;">${member.email}</p>
            <a href="/admin/members/${member.id}" style="display: inline-block; margin-top: 8px; color: #4F46E5; text-decoration: none; font-size: 12px; font-weight: 600;">View Profile â†’</a>
          </div>
        `;
        
        const marker = L.marker([lat, lon], { icon: memberIcon })
          .bindPopup(popupContent)
          .addTo(map);
        
        markers[member.id] = marker;
        
        results.push({ lat, lon });
      } else {
        console.warn(`No geocoding results for ${member.callsign}`);
        results.push(null);
      }
    } catch (error) {
      console.error(`Error geocoding address for ${member.callsign}:`, error);
      results.push(null);
    }
    
    // Wait 1 second between requests to respect rate limits
    if (i < members.length - 1) {
      await delay(1000);
    }
    
    // Update loading indicator progress
    const progress = Math.round(((i + 1) / members.length) * 100);
    const loadingText = document.querySelector('#loading-indicator p');
    if (loadingText) {
      loadingText.textContent = `Loading member locations... ${i + 1}/${members.length} (${progress}%)`;
    }
  }
  
  return results;
}

// Start geocoding and setup map
geocodeMembers().then(results => {
  const validResults = results.filter(r => r !== null);
  if (validResults.length > 0) {
    const bounds = L.latLngBounds(validResults.map(r => [r.lat, r.lon]));
    map.fitBounds(bounds, { padding: [50, 50] });
  }
  
  // Remove loading indicator
  setTimeout(() => {
    const loader = document.getElementById('loading-indicator');
    if (loader) loader.remove();
  }, 500);
});

// Add click handlers to table rows
document.querySelectorAll('.member-row').forEach(row => {
  row.addEventListener('click', function() {
    const memberId = this.dataset.memberId;
    const marker = markers[memberId];
    if (marker) {
      map.setView(marker.getLatLng(), 15);
      marker.openPopup();
      // Scroll to top to see the map
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });
});

// Add loading indicator
const loadingDiv = document.createElement('div');
loadingDiv.id = 'loading-indicator';
loadingDiv.innerHTML = `
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 1000; text-align: center;">
    <div style="width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top: 4px solid #4F46E5; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px;"></div>
    <p style="margin: 0; color: #6B7280; font-size: 14px;">Loading member locations...</p>
  </div>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
`;
document.getElementById('map').appendChild(loadingDiv);
</script>
